(()=>{"use strict";class e{static addField(e,t,a,l="text"){const r=document.createElement("div");r.setAttribute("class",`galleri-field galleri-field--${l}`),r.setAttribute("id",`galleri-field-${t}`),e.appendChild(r);const i=document.createElement("label");let n;return i.setAttribute("class","galleri-label"),i.setAttribute("for",`galleri-input-${t}`),i.innerText=a,r.appendChild(i),"select"===l?(n=document.createElement("select"),n.setAttribute("class","galleri-select")):(n=document.createElement("input"),n.setAttribute("class","galleri-input"),n.setAttribute("type",l)),n.setAttribute("id",`galleri-input-${t}`),n.setAttribute("name",t),r.appendChild(n),n}static callback(e,t){window.GALLERI.args.callbacks[e]&&window.GALLERI.args.callbacks[e](t)}static debounce(e,t,a){let l;return function(...r){const i=this,n=a&&!l;clearTimeout(l),l=setTimeout((()=>{l=null,a||e.apply(i,r)}),t),n&&e.apply(i,r)}}static isEmpty(){const e=window.getComputedStyle(window.GALLERI.elements.$imageList),t=window.getComputedStyle(window.GALLERI.elements.$folderList);return"none"===e.display&&"none"===t.display}static isLoggedIn(){return window.localStorage.getItem(window.GALLERI.args.localStorageKey)}static modifier(e,t){window.GALLERI.args.modifiers[e]&&window.GALLERI.args.modifiers[e](t)}static propertyExists(e,t){return Object.prototype.hasOwnProperty.call(e,t)}static setMetaTitle(e){const t=document.querySelector("title");t.innerText=e+window.GALLERI.args.metaTitleSeparator+t.innerText}static setPageTitle(t){let a=document.getElementById("galleri-folder-title-text");if(!a){const l=document.createElement("h1");l.setAttribute("id","galleri-folder-title"),window.GALLERI.elements.$container.prepend(l),a=document.createElement("span"),a.setAttribute("id","galleri-folder-title-text"),l.appendChild(a),window.GALLERI.elements.$numImages=document.createElement("small"),window.GALLERI.elements.$numImages.setAttribute("id","galleri-folder-num"),l.appendChild(window.GALLERI.elements.$numImages),e.modifier("title",{element:l,title:t})}a.innerText=t}static setNumImages(){const e=1===window.GALLERI.currentNumImages?window.GALLERI.lang.singularImageText:window.GALLERI.lang.pluralImageText;window.GALLERI.elements.$numImages.innerText=`(${window.GALLERI.currentNumImages.toLocaleString()} ${e})`}static sprintf(e,...t){return t.forEach((t=>{e=e.replace("%s",t)})),e}static toSlug(e){return e?e.toLowerCase().replace(/ & /g,"-and-").replace(/<[^>]+>/g,"").replace(/['â€™.]/g,"").replace(/[^a-z0-9-]+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/--+/g,"-"):""}}class t{static show(a,l={}){l.closeButtonText=l.closeButtonText||window.GALLERI.lang.ok,l.closeButtonClass=l.closeButtonClass||"",document.body.classList.add("galleri-modal-open");const r=`galleri-modal-${(new Date).getTime()}`,i=document.createElement("dialog");i.setAttribute("id",r),i.setAttribute("class","galleri-modal");const n=document.createElement("div");if(n.setAttribute("class","galleri-modal-box"),i.appendChild(n),l.append)n.appendChild(a);else{const e=document.createElement("p");e.setAttribute("class","galleri-modal-text"),e.innerText=a,n.appendChild(e)}let o;if(!l.hideClose||l.showCancel){const a=document.createElement("p");if(a.setAttribute("class","galleri-modal-options"),n.appendChild(a),!l.hideClose){const r=a=>{e.propertyExists(l,"callback")?l.callback(a):t.hide(a)};o=document.createElement("button"),o.setAttribute("id","galleri-modal-close"),o.setAttribute("type","button"),o.setAttribute("class",`galleri-button ${l.closeButtonClass}`.trim()),o.setAttribute("data-galleri-modal-close",""),l.closeButtonAttributes&&Object.keys(l.closeButtonAttributes).forEach((e=>{o.setAttribute(e,l.closeButtonAttributes[e])})),o.innerText=l.closeButtonText,o.addEventListener("click",r),a.appendChild(o),document.addEventListener("keydown",t.keydownListener,!1)}if(l.showCancel){const e=document.createElement("button");e.setAttribute("id","galleri-modal-cancel"),e.setAttribute("type","button"),e.setAttribute("class","galleri-button galleri-button--secondary"),e.innerText=window.GALLERI.lang.cancel,e.addEventListener("click",this.hide),a.appendChild(e)}}return document.body.appendChild(i),window.GALLERI.activeElement=document.activeElement,i.showModal(),o?o.focus():i.focus(),e.modifier("modal",{element:i}),i}static keydownListener(e){"Escape"===e.key&&(t.hide(),document.removeEventListener("keydown",t.keydownListener))}static hide(e){let t;document.body.classList.remove("galleri-modal-open"),t=e&&e.target?e.target:document.querySelector("[data-galleri-modal-close]");t.closest(".galleri-modal").remove(),window.GALLERI.activeElement&&(window.GALLERI.activeElement.focus(),window.GALLERI.activeElement=null)}}class a{static show(){let t=document.querySelector(".galleri-spinner");return t||(t=document.createElement("div"),t.setAttribute("class","galleri-spinner"),t.setAttribute("role","alert"),t.innerText=window.GALLERI.lang.loading,document.body.appendChild(t)),t.style.display="",e.modifier("spinner",{element:t}),t}static hide(e){e.style.display="none"}}class l{static request(t){(t=t||{}).method=t.method||"GET";const r=a.show();window.GALLERI.state.numRequestsInProgress+=1;const i=new XMLHttpRequest;i.onreadystatechange=()=>{if(i.readyState!==XMLHttpRequest.DONE)return;window.GALLERI.state.numRequestsInProgress-=1,window.GALLERI.state.numRequestsInProgress<=0&&a.hide(r);let e=i.responseText;if(e||!(i.status<200||i.status>299)){if(e&&!t.noParse)try{e=JSON.parse(e)}catch(a){return void l.error(t,e,i)}i.status<200||i.status>299?l.error(t,e,i):t.callback(e,i.status)}else l.error(t,e,i)};let n=t.url;t.url.endsWith(".json")&&e.isLoggedIn()&&(n+=`?t=${Date.now()}`),i.open(t.method,n,!0),t.json?(i.setRequestHeader("Content-Type","application/json"),i.send(t.json)):i.send(t.formData)}static error(a,l,r){a.errorCallback?a.errorCallback(l,r.status):t.show(e.sprintf(window.GALLERI.lang.error+window.GALLERI.lang.errorStatus,r.status))}}class r{static add(e,t){e.setAttribute("aria-invalid",!0);const a=e.closest(".galleri-field");a.classList.add("galleri-has-error");const l=document.createElement("span");l.setAttribute("class","galleri-error"),l.setAttribute("id",`galleri-error-${e.getAttribute("id")}`),l.innerText=t,a.append(l)}static clear(e){let t=e.querySelectorAll(".galleri-error");t.forEach((e=>{e.remove()})),t=e.querySelectorAll(".galleri-has-error"),t.forEach((e=>{e.classList.remove("galleri-has-error"),e.removeAttribute("aria-invalid")}))}static show(a,l){if(a.errors){const i=[];a.errors.forEach((e=>{if(e.pointer){const t=document.getElementById(`galleri-input-${e.pointer}`);t?r.add(t,window.GALLERI.lang.error+e.title):i.push(e.title)}else i.push(e.title)})),i.length>0&&t.show(e.sprintf(window.GALLERI.lang.error+i.join(" "),l))}else t.show(e.sprintf(window.GALLERI.lang.error+window.GALLERI.lang.errorStatus,l))}}class i{static show(t,a={}){a.class=a.class||"",a.closeButtonClass=a.closeButtonClass||"",a.closeButtonText=a.closeButtonText||window.GALLERI.lang.close,a.duration=a.duration||3e3;let l=document.getElementById("galleri-toast-container");l||(l=document.createElement("div"),l.setAttribute("id","galleri-toast-container"),document.getElementById("galleri-admin").append(l));const r=`galleri-toast-${(new Date).getTime()}`,n=document.createElement("div");n.setAttribute("class",`galleri-toast ${a.class}`.trim()),n.setAttribute("id",r),n.setAttribute("role","alert"),n.style.animationDuration=`${a.duration}ms`,l.appendChild(n);const o=document.createElement("p");if(o.setAttribute("class","galleri-toast-text"),o.innerText=t,n.appendChild(o),!a.hideClose){const e=e=>{i.hide(e)},t=document.createElement("button");t.setAttribute("class",`galleri-toast-close ${a.closeButtonClass}`.trim()),t.setAttribute("type","button"),a.closeButtonAttributes&&Object.keys(a.closeButtonAttributes).forEach((e=>{t.setAttribute(e,a.closeButtonAttributes[e])})),t.innerText=a.closeButtonText,t.addEventListener("click",e),n.appendChild(t)}return e.modifier("toast",{element:n}),setTimeout((()=>{n.remove()}),a.duration+1e3),n}static hide(e){e.target.closest(".galleri-toast").remove()}}class n{static load(){window.GALLERI.state.isLoadingFolder=!0,l.request({url:window.GALLERI.args.apiFoldersPath,callback:e=>{e?n.loadFolderCallback(e):l.request({url:`${window.GALLERI.args.apiPath}?type=folders`,callback:e=>{n.loadFolderCallback(e)}})},errorCallback:()=>{l.request({url:`${window.GALLERI.args.apiPath}?type=folders`,callback:e=>{n.loadFolderCallback(e)}})}})}static getCurrentFolderId(){if(!window.GALLERI.args.enableRewrites){return new URLSearchParams(window.location.search).get("folder")||""}return window.location.pathname.replace(/^\/+/,"")}static loadFolderCallback(a){const l=n.getCurrentFolderId();let r,i;if(window.GALLERI.folders=a.data,r=""===l?{id:"",type:"folders",attributes:{name:""}}:window.GALLERI.folders[l],r){if(window.GALLERI.currentFolder=r,""!==window.GALLERI.currentFolder.id&&n.initBreadcrumb(),r.attributes.name&&e.setMetaTitle(r.attributes.name),e.setPageTitle(r.attributes.name?r.attributes.name:window.GALLERI.lang.home),""===window.GALLERI.currentFolder.id)i=Object.values(window.GALLERI.folders).filter((e=>!e.id.includes("/")));else{const e=window.GALLERI.currentFolder.id.split("/").length+1;i=Object.values(window.GALLERI.folders).filter((t=>!!t.id.startsWith(`${window.GALLERI.currentFolder.id}/`)&&e===t.id.split("/").length))}i.length>0&&n.appendItems(i),window.GALLERI.state.isLoadingFolder=!1,e.callback("afterLoadFolder",{folder:r})}else t.show(window.GALLERI.lang.error+window.GALLERI.lang.errorFolderDoesNotExist)}static url(e){return window.GALLERI.args.enableRewrites?`/${e.id}`:`/?folder=${e.id}`}static element(t){const a=document.createElement(window.GALLERI.args.folderItemElement);a.setAttribute("class","galleri-folder"),a.setAttribute("data-path",t.id);const l=document.createElement("a");if(l.setAttribute("class","galleri-folder-link"),l.setAttribute("href",n.url(t)),a.appendChild(l),t.attributes.thumbnail){const e=document.createElement("img");e.setAttribute("class","galleri-folder-img"),e.setAttribute("src",t.attributes.thumbnail),l.appendChild(e)}const r=document.createElement("div");return r.setAttribute("class","galleri-folder-name"),r.innerText=t.attributes.name,l.appendChild(r),e.modifier("folderItem",{element:a,folder:t}),a}static showCreateForm(){const a=n.form(window.GALLERI.lang.titleCreateFolder,"post",n.submitCreateFormCallback),l=a.querySelector("#galleri-input-parent");l&&n.addFolderOptions(l,window.GALLERI.currentFolder.id);const r=a.querySelector("#galleri-field-parent");Object.keys(window.GALLERI.folders).length<=0?r.style.display="none":r.style.display="",e.modifier("folderCreateForm",{addField:e.addField,form:a}),t.show(a,{append:!0,callback:n.submitCreateFormCallback,closeButtonAttributes:{form:"galleri-folder-form",type:"submit"},closeButtonText:window.GALLERI.lang.save,showCancel:!0})}static showEditForm(){const a=n.form(window.GALLERI.lang.titleEditFolder,"put",n.submitEditFormCallback,window.GALLERI.currentFolder.id),l=a.querySelector("#galleri-input-parent");l&&n.addFolderOptions(l,n.getParentId(window.GALLERI.currentFolder.id));const r=a.querySelector("#galleri-field-parent");Object.keys(window.GALLERI.folders).length<=0?r.style.display="none":r.style.display="";const i=a.querySelector("#galleri-input-id");i&&(i.value=window.GALLERI.currentFolder.id.replace(/^.+\/([^/]+)$/,"$1")),Object.keys(window.GALLERI.currentFolder.attributes).forEach((e=>{const t=a.querySelector(`#galleri-input-${e}`);t&&t.setAttribute("value",window.GALLERI.currentFolder.attributes[e])})),e.modifier("folderEditForm",{addField:e.addField,form:a}),t.show(a,{append:!0,callback:n.submitEditFormCallback,closeButtonAttributes:{form:"galleri-folder-form",type:"submit"},closeButtonText:window.GALLERI.lang.save,showCancel:!0})}static form(t,a,l,r=""){const i=document.createElement("form");let n=`${window.GALLERI.args.apiPath}?type=folders`;r&&(n+=`&id=${r}`),i.setAttribute("action",n),i.setAttribute("id","galleri-folder-form"),i.setAttribute("method",a),i.addEventListener("submit",l);const o=document.createElement("h2");o.setAttribute("class","galleri-heading"),o.innerText=t,i.appendChild(o);const d=document.createElement("div");d.setAttribute("class","galleri-fields"),i.appendChild(d);const s=e.addField(d,"name",window.GALLERI.lang.fieldFolderName),c=e.addField(d,"id",window.GALLERI.lang.fieldFolderId);return e.addField(d,"parent",window.GALLERI.lang.fieldFolderParent,"select"),e.addField(d,"thumbnail",window.GALLERI.lang.fieldFolderThumbnail),s.addEventListener("keyup",(t=>{c.value=e.toSlug(t.target.value)})),s.addEventListener("change",(t=>{c.value=e.toSlug(t.target.value)})),e.modifier("folderForm",{addField:e.addField,container:d,form:i}),i}static delete(){const a=window.GALLERI.currentFolder.id;t.show(e.sprintf(window.GALLERI.lang.confirmDeleteFolder,window.GALLERI.currentFolder.attributes.name),{closeButtonText:window.GALLERI.lang.delete,closeButtonClass:"galleri-button--danger",showCancel:!0,callback:()=>{n.deleteCallback(a),t.hide()}})}static deleteCallback(t){l.request({method:"DELETE",url:`${window.GALLERI.args.apiPath}?type=folders&id=${t}`,callback:()=>{e.callback("afterDeleteFolder",{id:t});const a=n.getParentId(window.GALLERI.currentFolder.id);window.location=window.location.href.replace(n.url(window.GALLERI.currentFolder),a?n.url(window.GALLERI.folders[a]):"")}})}static submitCreateFormCallback(e){e.preventDefault();const t=document.getElementById("galleri-folder-form");r.clear(t);const a=document.getElementById("galleri-input-name");if(!a.value)return void r.add(a,window.GALLERI.lang.validationRequired);const i=document.getElementById("galleri-input-id");if(!i.value)return void r.add(i,window.GALLERI.lang.validationRequired);const o=new FormData(t);let d={id:null,attributes:{}};o.forEach(((e,t)=>{"id"===t?d[t]=e:d.attributes[t]=e})),d=JSON.stringify(d),l.request({method:t.getAttribute("method"),url:t.getAttribute("action"),json:d,callback:e=>{n.createRequestCallback(e)},errorCallback:(e,t)=>{r.show(e,t)}})}static createRequestCallback(t){i.show(window.GALLERI.lang.createdSuccessfullyFolder,{class:"galleri-toast--success"});const a=n.getParentId(t.data.id);if(a&&a===window.GALLERI.currentFolder.id||!a&&!window.GALLERI.currentFolder.id){n.addToList(t.data);const e=document.getElementById("galleri-delete-folder");e&&(e.style.display="none")}document.getElementById("galleri-input-name").value="",document.getElementById("galleri-input-id").value="",window.GALLERI.folders[t.data.id]=t.data;const l=document.getElementById("galleri-input-parent");n.addFolderOptions(l,l.value);document.getElementById("galleri-field-parent").style.display="",e.callback("afterCreateFolder",{folder:t.data})}static submitEditFormCallback(e){e.preventDefault();const a=document.getElementById("galleri-folder-form");r.clear(a);const o=document.getElementById("galleri-input-name");if(!o.value)return void r.add(o,window.GALLERI.lang.validationRequired);const d=document.getElementById("galleri-input-id");if(!d.value)return void r.add(d,window.GALLERI.lang.validationRequired);const s=new FormData(a);let c={attributes:{}},u={attributes:{}};if(s.forEach(((e,t)=>{"id"===t?(c[t]=e,Object.prototype.hasOwnProperty.call(window.GALLERI.currentFolder,t)?u[t]=window.GALLERI.currentFolder[t].replace(/^.+\/([^/]+)$/,"$1"):u[t]=""):(c.attributes[t]=e,Object.prototype.hasOwnProperty.call(window.GALLERI.currentFolder.attributes,t)?u.attributes[t]=window.GALLERI.currentFolder.attributes[t]:u.attributes[t]="")})),c=JSON.stringify(c),u=JSON.stringify(u),c===u)return i.show(window.GALLERI.lang.nothingToSave),void t.hide(e);l.request({method:a.getAttribute("method"),url:a.getAttribute("action"),json:c,callback:e=>{n.editRequestCallback(e)},errorCallback:(e,t)=>{r.show(e,t)}})}static editRequestCallback(t){e.callback("afterEditFolder",{folder:t.data}),window.location=window.location.href.replace(n.url(window.GALLERI.currentFolder),n.url(t.data))}static appendItems(e){e.forEach((e=>{window.GALLERI.elements.$folderList.appendChild(n.element(e))}))}static addToList(e){let t;const a=window.GALLERI.elements.$folderList.children,l=a.length;let r;for(t=0;t<l&&a[t].getAttribute("data-path")<e.id;t+=1)r=a[t];r?r.after(n.element(e)):window.GALLERI.elements.$folderList.prepend(n.element(e))}static getFullName(e){const t=[e.attributes.name];let a=n.getParentId(e.id);for(;a&&window.GALLERI.folders[a];)e=window.GALLERI.folders[a],t.push(e.attributes.name),a=n.getParentId(e.id);return t.reverse().join(window.GALLERI.args.folderSeparator)}static getParentId(e){const t=e.lastIndexOf("/");return-1===t?"":e.substr(0,t)}static getFolders(){return document.querySelectorAll(`#galleri-folders > ${window.GALLERI.args.folderItemElement}`)}static hasFolders(){return n.getFolders().length>0}static addFolderOptions(e,t){e.innerText="";let a=document.createElement("option");a.setAttribute("value",""),e.appendChild(a);let l;Object.keys(window.GALLERI.folders).sort().forEach((r=>{l=window.GALLERI.folders[r],a=document.createElement("option"),a.setAttribute("value",l.id),a.innerText=n.getFullName(window.GALLERI.folders[l.id]),l.id===t&&a.setAttribute("selected","selected"),e.appendChild(a)}))}static initBreadcrumb(){const t=document.createElement("ul");t.setAttribute("class","galleri-breadcrumb"),window.GALLERI.elements.$container.prepend(t);let a=window.GALLERI.currentFolder;do{t.prepend(this.breadcrumbItem(a)),a=window.GALLERI.folders[n.getParentId(a.id)]}while(a);t.prepend(this.breadcrumbItem({id:"",attributes:{name:window.GALLERI.lang.home}})),e.modifier("breadcrumbList",{element:t,folder:window.GALLERI.currentFolder})}static breadcrumbItem(t){const a=document.createElement("li");if(a.setAttribute("class","galleri-breadcrumb-item"),t.id===window.GALLERI.currentFolder.id)a.innerText=t.attributes.name;else{const e=document.createElement("a");e.setAttribute("class","galleri-breadcrumb-link"),e.setAttribute("href",t.id?n.url(t):"/"),e.innerText=t.attributes.name,a.prepend(e)}return e.modifier("breadcrumbItem",{element:a,folder:t}),a}}class o{static load(){window.GALLERI.state.isLoadingImages=!0,l.request({url:window.GALLERI.args.apiImagesPath,callback:e=>{e?o.getImagesCallback(e):l.request({url:`${window.GALLERI.args.apiPath}?type=images`,callback:e=>{o.getImagesCallback(e)}})},errorCallback:()=>{l.request({url:`${window.GALLERI.args.apiPath}?type=images`,callback:e=>{o.getImagesCallback(e)}})}})}static getImagesCallback(t){const a=n.getCurrentFolderId();let l=Object.values(t.data);if(window.GALLERI.args.showAllImages||(l=l.filter((e=>e.attributes.folder===a))),e.modifier("images",{images:l}),l.forEach((e=>{window.GALLERI.currentImages[e.id]=e})),o.appendItems(l),window.GALLERI.grid&&window.GALLERI.grid.resizeAllItems(),window.GALLERI.state.allPagesLoaded=!0,window.GALLERI.currentNumImages=l.length,l.length<=0){if(!n.hasFolders()){const e=document.getElementById("galleri-delete-folder");e&&(e.style.display="")}}else{const e=document.getElementById("galleri-delete-folder");e&&(e.style.display="none")}window.GALLERI.state.isLoadingImages=!1,o.onScroll(),window.addEventListener("scroll",e.debounce((()=>{o.onScroll()}),100)),e.callback("afterLoadImages",{images:l})}static element(t,a=!1){const l=document.createElement(window.GALLERI.args.imageItemElement);l.setAttribute("class","galleri-figure"),l.setAttribute("data-path",t.id);const r=document.createElement("a");r.setAttribute("class","galleri-link"),r.setAttribute("href",t.meta.url),l.appendChild(r);const i=document.createElement("img");return t.attributes.title&&i.setAttribute("alt",t.attributes.title),i.setAttribute("class","galleri-img"),i.setAttribute("data-src",t.meta.thumbnail),i.setAttribute("height",t.meta.thumbnailHeight),i.setAttribute("width",t.meta.thumbnailWidth),r.appendChild(i),a&&(o.setSrc(i),e.isLoggedIn()&&o.addAdminControls(l,t)),e.modifier("imageItem",{element:l,image:t}),l}static showCreateForm(){const a=document.createElement("form");a.setAttribute("action",`${window.GALLERI.args.apiPath}?type=images`),a.setAttribute("enctype","multipart/form-data"),a.setAttribute("id","galleri-image-form"),a.setAttribute("method","post"),a.addEventListener("submit",o.submitCreateFormCallback);const l=document.createElement("h2");l.setAttribute("class","galleri-heading"),l.innerText=window.GALLERI.lang.uploadImage,a.appendChild(l);const r=document.createElement("div");r.setAttribute("class","galleri-field"),r.setAttribute("id","galleri-field-upload"),a.appendChild(r);const i=document.createElement("label");i.setAttribute("class","galleri-label"),i.setAttribute("for","galleri-input-upload"),i.innerText=window.GALLERI.lang.fieldImageImages,r.appendChild(i);const n=document.createElement("div");n.setAttribute("class","galleri-file-container"),r.appendChild(n);const d=document.createElement("input");d.setAttribute("accept","image/*"),d.setAttribute("class","galleri-file-input"),d.setAttribute("id","galleri-input-upload"),d.setAttribute("name","upload[]"),d.setAttribute("multiple","multiple"),d.setAttribute("type","file"),d.addEventListener("change",o.onChange),n.appendChild(d);const s=document.createElement("div");s.setAttribute("class","galleri-file-text"),s.setAttribute("id","galleri-create-image-text"),s.innerText=window.GALLERI.lang.dragImagesOrClickHereToUpload,n.appendChild(s);const c=document.createElement("input");c.setAttribute("name","folder"),c.setAttribute("value",window.GALLERI.currentFolder.id),c.setAttribute("type","hidden"),a.appendChild(c),e.modifier("imageCreateForm",{addField:e.addField,form:a}),t.show(a,{append:!0,callback:o.submitCreateFormCallback,closeButtonAttributes:{form:"galleri-image-form",type:"submit"},closeButtonText:window.GALLERI.lang.upload,showCancel:!0})}static showEditForm(a){const l=a.target.closest("[data-path]").getAttribute("data-path");window.GALLERI.currentImage=window.GALLERI.currentImages[l];const r=document.createElement("form");r.setAttribute("action",`${window.GALLERI.args.apiPath}?type=images&id=${window.GALLERI.currentImage.id}`),r.setAttribute("id","galleri-image-form"),r.setAttribute("method","PUT"),r.addEventListener("submit",o.submitEditFormCallback);const i=document.createElement("h2");i.setAttribute("class","galleri-heading"),i.innerText=window.GALLERI.lang.titleEditImage,r.appendChild(i);const d=document.createElement("div");d.setAttribute("class","galleri-fields"),r.appendChild(d),e.addField(d,"filename",window.GALLERI.lang.fieldImageFilename);const s=e.addField(d,"folder",window.GALLERI.lang.fieldImageFolder,"select");n.addFolderOptions(s,window.GALLERI.currentImage.attributes.folder),e.addField(d,"title",window.GALLERI.lang.fieldImageTitle),Object.keys(window.GALLERI.currentImage.attributes).forEach((e=>{const t=r.querySelector(`#galleri-input-${e}`);t&&Object.prototype.hasOwnProperty.call(window.GALLERI.currentImage.attributes,e)&&t.setAttribute("value",window.GALLERI.currentImage.attributes[e])})),e.modifier("imageEditForm",{addField:e.addField,container:d,form:r}),t.show(r,{append:!0,callback:o.submitEditFormCallback,closeButtonAttributes:{form:"galleri-image-form",type:"submit"},closeButtonText:window.GALLERI.lang.save,showCancel:!0})}static delete(a){const l=a.target.closest("[data-path]").getAttribute("data-path");t.show(e.sprintf(window.GALLERI.lang.confirmDeleteImage,l),{closeButtonText:window.GALLERI.lang.delete,closeButtonClass:"galleri-button--danger",showCancel:!0,callback:()=>{o.deleteCallback(l),t.hide()}})}static deleteCallback(t){l.request({method:"DELETE",url:`${window.GALLERI.args.apiPath}?type=images&id=${t}`,callback:()=>{i.show(window.GALLERI.lang.deletedSuccessfullyImage,{class:"galleri-toast--success"}),o.removeImageFromList(t),e.callback("afterDeleteImage",{id:t})}})}static setThumbnail(e){e.target.getAttribute("data-current-thumbnail")?o.removeThumbnail(e):o.makeThumbnail(e)}static makeThumbnail(t){const a=t.target.closest("[data-path]").getAttribute("data-path"),r=window.GALLERI.currentImages[a],n=window.GALLERI.currentFolder.id,o={id:n,attributes:window.GALLERI.currentFolder.attributes};o.attributes.thumbnail=r.meta.thumbnail,l.request({method:"PUT",url:`${window.GALLERI.args.apiPath}?type=folders&id=${n}`,json:JSON.stringify(o),callback:()=>{i.show(window.GALLERI.lang.updatedSuccessfullyThumbnail,{class:"galleri-toast--success"});const a=document.querySelector("[data-current-thumbnail]");a&&(a.innerText=window.GALLERI.lang.makeThumbnail,a.removeAttribute("data-current-thumbnail")),t.target.innerText=window.GALLERI.lang.removeThumbnail,t.target.setAttribute("data-current-thumbnail",!0),e.callback("afterMakeThumbnail",{folderId:n,image:r})},errorCallback:()=>{i.show(window.GALLERI.lang.errorUpdatingThumbnail,{class:"galleri-toast--danger"})}})}static removeThumbnail(t){const a=t.target.closest("[data-path]").getAttribute("data-path"),r=window.GALLERI.currentImages[a],n=window.GALLERI.currentFolder.id,o={id:n,attributes:window.GALLERI.currentFolder.attributes};o.attributes.thumbnail="",l.request({method:"PUT",url:`${window.GALLERI.args.apiPath}?type=folders&id=${n}`,json:JSON.stringify(o),callback:()=>{i.show(window.GALLERI.lang.removedSuccessfullyThumbnail,{class:"galleri-toast--success"}),t.target.innerText=window.GALLERI.lang.makeThumbnail,t.target.removeAttribute("data-current-thumbnail"),e.callback("afterRemoveThumbnail",{folderId:n,image:r})},errorCallback:()=>{i.show(window.GALLERI.lang.errorRemovingThumbnail,{class:"galleri-toast--danger"})}})}static submitCreateFormCallback(e){e.preventDefault();const t=document.getElementById("galleri-image-form");r.clear(t);const a=document.getElementById("galleri-input-upload");if(a.files.length<=0)return void r.add(a,window.GALLERI.lang.validationRequired);const i=new FormData(t);l.request({method:t.getAttribute("method"),url:t.getAttribute("action"),formData:i,callback:e=>{o.createRequestCallback(e)},errorCallback:(e,t)=>{r.show(e,t)}})}static createRequestCallback(t){i.show(window.GALLERI.lang.createdSuccessfullyImage,{class:"galleri-toast--success"}),o.prependItems(t.data),window.GALLERI.grid&&window.GALLERI.grid.resizeAllItems(),t.data.forEach((e=>{window.GALLERI.currentImages[e.id]=e})),window.GALLERI.currentNumImages+=t.data.length,e.setNumImages(),document.getElementById("galleri-input-upload").value="",document.getElementById("galleri-create-image-text").innerText=window.GALLERI.lang.dragImagesOrClickHereToUpload;const a=document.getElementById("galleri-delete-folder");a&&(a.style.display="none"),e.callback("afterCreateImage",{image:t.data})}static submitEditFormCallback(e){e.preventDefault();const a=document.getElementById("galleri-image-form");r.clear(a);const n=document.getElementById("galleri-input-filename");if(!n.value)return void r.add(n,window.GALLERI.lang.validationRequired);const d=new FormData(a);let s={},c={};if(d.forEach(((e,t)=>{s[t]=e,Object.prototype.hasOwnProperty.call(window.GALLERI.currentImage.attributes,t)?c[t]=window.GALLERI.currentImage.attributes[t]:c[t]=""})),s=JSON.stringify(s),c=JSON.stringify(c),s===c)return i.show(window.GALLERI.lang.nothingToSave),void t.hide(e);l.request({method:a.getAttribute("method"),url:a.getAttribute("action"),json:s,callback:t=>{o.editRequestCallback(e,t)},errorCallback:(e,t)=>{r.show(e,t)}})}static editRequestCallback(a,l){i.show(window.GALLERI.lang.updatedSuccessfullyImage,{class:"galleri-toast--success"});document.getElementById("galleri-input-folder").value!==window.GALLERI.currentImage.attributes.folder?o.removeImageFromList(window.GALLERI.currentImage.id):o.updateImage(window.GALLERI.currentImage.id,l.data),delete window.GALLERI.currentImages[window.GALLERI.currentImage.id],window.GALLERI.currentImages[l.data.id]=l.data,window.GALLERI.currentImage=null,t.hide(a),e.callback("afterEditImage",{image:l.data})}static appendItems(e){const t=e.map((e=>o.element(e)));window.GALLERI.elements.$imageList.append(...t)}static prependItems(e){e.forEach((e=>{window.GALLERI.elements.$imageList.prepend(o.element(e,!0))}))}static removeImageFromList(t){const a=document.querySelector(`[data-path="${t}"]`);let l;if(a.nextSibling&&(l=a.nextSibling.querySelector("button")),!l&&a.previousSibling&&(l=a.previousSibling.querySelector("button")),a.remove(),window.GALLERI.currentNumImages-=1,e.setNumImages(),o.hasImages())window.GALLERI.grid&&window.GALLERI.grid.resizeAllItems(),l&&l.focus();else if(!n.hasFolders()){const e=document.getElementById("galleri-delete-folder");e&&(e.style.display="")}}static onChange(e){const t=[...e.target.files].map((e=>e.name));document.getElementById("galleri-create-image-text").innerText=t.join(", ")}static updateImage(t,a){const l=document.querySelector(`[data-path="${t}"]`);l.setAttribute("data-path",a.id);l.querySelector(".galleri-link").setAttribute("href",a.meta.url);const r=l.querySelector(".galleri-img");a.attributes.title?r.setAttribute("alt",a.attributes.title):r.removeAttribute("alt"),e.callback("afterUpdateImage",{image:a,element:l})}static view(e){e.target.closest("[data-path]").querySelector(".galleri-link").click()}static getImages(){return document.querySelectorAll(`#galleri-images > ${window.GALLERI.args.imageItemElement}`)}static hasImages(){return o.getImages().length>0}static addAdminControls(e,t){if(e.querySelector(".galleri-admin"))return;const a=document.createElement("div");a.setAttribute("class","galleri-admin galleri-button-container"),e.appendChild(a);const l=document.createElement("button");l.setAttribute("class","galleri-button"),l.setAttribute("href","button"),l.innerText=window.GALLERI.lang.view,l.addEventListener("click",o.view),a.appendChild(l);const r=document.createElement("button");if(r.setAttribute("class","galleri-button galleri-button--secondary"),r.setAttribute("type","button"),r.innerText=window.GALLERI.lang.edit,r.addEventListener("click",o.showEditForm),a.appendChild(r),t.attributes.folder){const e=document.createElement("button");e.setAttribute("class","galleri-button galleri-button--secondary"),e.setAttribute("href","button"),e.setAttribute("data-thumbnail-button",!0),e.addEventListener("click",o.setThumbnail);const l=window.GALLERI.folders[t.attributes.folder];l&&l.attributes.thumbnail===t.meta.thumbnail?(e.setAttribute("data-current-thumbnail",!0),e.innerText=window.GALLERI.lang.removeThumbnail):e.innerText=window.GALLERI.lang.makeThumbnail,a.appendChild(e)}const i=document.createElement("button");if(i.setAttribute("class","galleri-button galleri-button--danger"),i.setAttribute("type","button"),i.innerText=window.GALLERI.lang.delete,i.addEventListener("click",o.delete),a.appendChild(i),window.GALLERI.args.removePointerEventsOnLogin){const t=e.querySelector(".galleri-link");t.style.pointerEvents="none",t.setAttribute("tabindex",-1)}}static onScroll(){const e=document.querySelectorAll("[data-src]"),t=window.innerHeight,a=window.scrollY+t+t;e.forEach((e=>{e.getBoundingClientRect().top<=a&&o.setSrc(e)}))}static setSrc(t){const a=t.getAttribute("data-src");t.setAttribute("src",a),t.removeAttribute("data-src"),t.closest(".galleri-link").style.backgroundImage=`url("${a}")`,e.callback("afterLoadImage",{element:t})}}class d{static init(){window.GALLERI.elements.$authenticateButton&&(window.GALLERI.elements.$authenticateButton.addEventListener("click",(()=>{d.authenticate()})),d.handleAuthentication())}static authenticate(){e.isLoggedIn()?d.logout():d.login()}static logout(){if(window.navigator.userAgent.indexOf("Safari")>-1)return void d.logoutCallback();const e=[window.location.protocol,"//log:out@",window.location.host,`${window.GALLERI.args.apiPath}?type=sessions`].join("");l.request({method:"DELETE",url:e,noParse:!0,callback:()=>{d.logoutCallback()},errorCallback:()=>{d.logoutCallback()}})}static logoutCallback(){window.localStorage.clear(),d.handleLogout()}static login(){l.request({method:"POST",url:`${window.GALLERI.args.apiPath}?type=sessions`,noParse:!0,callback:(e,a)=>{204===a?(window.localStorage.setItem(window.GALLERI.args.localStorageKey,!0),this.handleLogin()):t.show(window.GALLERI.lang.error+window.GALLERI.lang.errorInvalidUsername)}})}static handleAuthentication(){e.isLoggedIn()?d.handleLogin():d.handleLogout()}static handleLogin(){window.GALLERI.elements.$authenticateButton.innerText=window.GALLERI.lang.logOut,document.body.classList.add("galleri-is-admin"),d.addAdminBar(),o.getImages().forEach((e=>{const t=e.getAttribute("data-path");o.addAdminControls(e,window.GALLERI.currentImages[t])})),e.callback("afterLogin")}static handleLogout(){window.GALLERI.elements.$authenticateButton.innerText=window.GALLERI.lang.logIn,document.body.classList.remove("galleri-is-admin");let t=document.querySelectorAll(".galleri-admin");t.forEach((e=>{e.remove()})),window.GALLERI.args.removePointerEventsOnLogin&&(t=document.querySelectorAll(".galleri-link"),t.forEach((e=>{e.removeAttribute("tabindex"),e.style.pointerEvents=""}))),e.callback("afterLogout")}static addAdminBar(){const t=document.createElement("div");t.setAttribute("id","galleri-admin"),t.setAttribute("class","galleri-admin"),window.GALLERI.elements.$container.prepend(t);const a=document.createElement("div");a.setAttribute("class","galleri-button-container"),a.setAttribute("id","galleri-admin-buttons"),t.prepend(a);const l=document.createElement("button");l.setAttribute("class","galleri-button"),l.setAttribute("id","galleri-create-image"),l.setAttribute("type","button"),l.innerText=window.GALLERI.lang.uploadImage,l.addEventListener("click",o.showCreateForm),a.append(l);const r=document.createElement("button");if(r.setAttribute("class","galleri-button galleri-button--secondary"),r.setAttribute("id","galleri-create-folder"),r.setAttribute("type","button"),r.innerText=window.GALLERI.lang.createFolder,r.addEventListener("click",n.showCreateForm),a.append(r),window.GALLERI.currentFolder.id){const t=document.createElement("button");t.setAttribute("class","galleri-button galleri-button--secondary"),t.setAttribute("id","galleri-edit-folder"),t.setAttribute("type","button"),t.innerText=window.GALLERI.lang.editFolder,t.addEventListener("click",n.showEditForm),a.append(t);const l=document.createElement("button");l.setAttribute("class","galleri-button galleri-button--danger"),l.setAttribute("id","galleri-delete-folder"),l.setAttribute("type","button"),l.innerText=window.GALLERI.lang.deleteFolder,e.isEmpty()||(l.style.display="none"),l.addEventListener("click",n.delete),a.append(l)}e.modifier("adminBar",{element:a})}}class s{constructor(){window.GALLERI.elements.$imageList.classList.add("galleri-grid"),this.calculate(),window.addEventListener("resize",e.debounce((()=>{this.calculate(),this.resizeAllItems()}),100))}calculate(){const e=window.getComputedStyle(window.GALLERI.elements.$imageList);this.gridRowHeight=parseInt(e.getPropertyValue("grid-auto-rows"),10),this.gridRowGap=parseInt(e.getPropertyValue("grid-row-gap"),10)}checkResizeItem(e){const t=e.querySelector("img");this.resizeItem(e,t),t.onload=()=>{this.resizeItem(e,t);e.querySelector("a").classList.add("galleri-show")}}resizeItem(e,t){const a=t.getBoundingClientRect().height,l=Math.ceil((a+this.gridRowGap)/(this.gridRowHeight+this.gridRowGap));e.style.gridRowEnd=`span ${l}`}resizeAllItems(){[...document.getElementsByClassName("galleri-figure")].forEach((e=>{this.checkResizeItem(e)}))}}class c{constructor(t){(t=t||{}).apiFoldersPath=t.apiFoldersPath||"/json/folders.json",t.apiImagesPath=t.apiImagesPath||"/json/images.json",t.apiPath=t.apiPath||"/api.php",t.callbacks=t.callbacks||{},t.enableGrid=!e.propertyExists(t,"enableGrid")||t.enableGrid,t.enableRewrites=!e.propertyExists(t,"enableRewrites")||t.enableRewrites,t.folderItemElement=t.folderItemElement||"li",t.folderSeparator=t.folderSeparator||" > ",t.imageItemElement=t.imageItemElement||"figure",t.localStorageKey=t.localStorageKey||"authenticated",t.metaTitleSeparator=t.metaTitleSeparator||" | ",t.modifiers=t.modifiers||{},t.pageSize=t.pageSize||8,t.removePointerEventsOnLogin=!e.propertyExists(t,"removePointerEventsOnLogin")||t.removePointerEventsOnLogin,t.selector=t.selector||"#galleri",t.showAllImages=!!e.propertyExists(t,"showAllImages")&&t.showAllImages,this.args=t;const a=document.querySelector(t.selector);if(!a)return;const l=t.lang||{};l.cancel=l.cancel||"Cancel",l.close=l.close||"Close",l.confirmDeleteFolder=l.confirmDeleteFolder||'Are you sure you want to delete the folder "%s"?',l.confirmDeleteImage=l.confirmDeleteImage||'Are you sure you want to delete the image "%s"?',l.createdSuccessfullyImage=l.createdSuccessfullyImage||"Image uploaded successfully.",l.createdSuccessfullyFolder=l.createdSuccessfullyFolder||"Folder created successfully.",l.createFolder=l.createFolder||"Create Folder",l.delete=l.delete||"Delete",l.deletedSuccessfullyImage=l.deletedSuccessfullyImage||"Image deleted successfully.",l.deletedSuccessfullyFolder=l.deletedSuccessfullyFolder||"Folder deleted successfully.",l.deleteFolder=l.deleteFolder||"Delete Folder",l.dragImagesOrClickHereToUpload=l.dragImagesOrClickHereToUpload||"Drag images or click here to upload.",l.edit=l.edit||"Edit",l.editFolder=l.editFolder||"Edit Folder",l.error=l.error||"Error: ",l.errorFolderDoesNotExist=l.errorFolderDoesNotExist||"This folder does not exist.",l.errorInvalidUsername=l.errorInvalidUsername||"Invalid username or password.",l.errorUpdatingThumbnail=l.errorUpdatingThumbnail||"Error updating thumbnail.",l.errorRemovingThumbnail=l.errorRemovingThumbnail||"Error removing thumbnail.",l.errorStatus=l.errorStatus||"The server returned a %s error.",l.fieldFolderId=l.fieldFolderId||"ID",l.fieldFolderName=l.fieldFolderName||"Name",l.fieldFolderParent=l.fieldFolderParent||"Parent",l.fieldFolderThumbnail=l.fieldFolderThumbnail||"Thumbnail",l.fieldImageImages=l.fieldImageImages||"Images",l.fieldImageFilename=l.fieldImageFilename||"Filename",l.fieldImageTitle=l.fieldImageTitle||"Title",l.fieldImageFolder=l.fieldImageFolder||"Folder",l.home=l.home||"Home",l.loading=l.loading||"Loading...",l.logIn=l.logIn||"Log In",l.logOut=l.logOut||"Log Out",l.makeThumbnail=l.makeThumbnail||"Make Thumbnail",l.nothingToSave=l.nothingToSave||"Nothing to save.",l.ok=l.ok||"OK",l.pluralImageText=l.pluralImageText||"images",l.removeThumbnail=l.removeThumbnail||"Remove Thumbnail",l.removedSuccessfullyThumbnail=l.removedSuccessfullyThumbnail||"Thumbnail removed successfully.",l.save=l.save||"Save",l.singularImageText=l.singularImageText||"image",l.submitCreateFolder=l.submitCreateFolder||"Create",l.submitEditFolder=l.submitEditFolder||"Save",l.titleCreateFolder=l.titleCreateFolder||"Create Folder",l.titleEditFolder=l.titleEditFolder||"Edit Folder",l.titleEditImage=l.titleEditImage||"Edit Image",l.updatedSuccessfullyImage=l.updatedSuccessfullyImage||"Image updated successfully.",l.updatedSuccessfullyFolder=l.updatedSuccessfullyFolder||"Folder updated successfully.",l.updatedSuccessfullyThumbnail=l.updatedSuccessfullyThumbnail||"Thumbnail updated successfully.",l.upload=l.upload||"Upload",l.uploadImage=l.uploadImage||"Upload Image",l.validationRequired=l.validationRequired||"Error: This field is required.",l.view=l.view||"View",this.lang=l;const r=document.createElement("ul");r.setAttribute("id","galleri-folders"),a.appendChild(r);const i=document.createElement("div");i.setAttribute("id","galleri-images"),a.appendChild(i),this.elements={$authenticateButton:document.querySelector('[data-action="authenticate"]'),$container:a,$folderList:r,$imageList:i},this.state={isLoadingFolder:!1,isLoadingImages:!1,numRequestsInProgress:0},this.currentFolder=null,this.currentImage=null,this.currentImages={},this.currentNumImages=null,this.folders=[]}static init(t){if(!e.propertyExists(window,"GALLERI")){if(window.GALLERI=new c(t),!window.GALLERI.elements.$imageList)return null;n.load(),o.load(),t.enableGrid&&(window.GALLERI.grid=new s);let a=setInterval((()=>{window.GALLERI.state.isLoadingFolder||window.GALLERI.state.isLoadingImages||(d.init(),e.setNumImages(),clearInterval(a),a=null)}),250)}return window.GALLERI}}window.galleri=c})();