var Robroy;(()=>{"use strict";var e={d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{e.r(t),e.d(t,{default:()=>m});class r{static addField(e,t,r,o="text"){const a=document.createElement("div");a.setAttribute("class",`robroy-field robroy-field--${o}`),a.setAttribute("id",`robroy-field-${t}`),e.appendChild(a);const n=document.createElement("label");let i;return n.setAttribute("class","robroy-label"),n.setAttribute("for",`robroy-input-${t}`),n.innerText=r,a.appendChild(n),"select"===o?(i=document.createElement("select"),i.setAttribute("class","robroy-select")):(i=document.createElement("input"),i.setAttribute("class","robroy-input"),i.setAttribute("type",o)),i.setAttribute("id",`robroy-input-${t}`),i.setAttribute("name",t),a.appendChild(i),i}static callback(e,t){window.ROBROY.args.callbacks[e]&&window.ROBROY.args.callbacks[e](t)}static debounce(e,t,r,...o){let a;return()=>{const n=this,i=r&&!a;clearTimeout(a),a=setTimeout((()=>{a=null,r||e.apply(n,o)}),t),i&&e.apply(n,o)}}static isEmpty(){const e=window.getComputedStyle(window.ROBROY.elements.$imageList),t=window.getComputedStyle(window.ROBROY.elements.$folderList);return"none"===e.display&&"none"===t.display}static isLoggedIn(){return window.localStorage.getItem(window.ROBROY.args.localStorageKey)}static modifier(e,t){window.ROBROY.args.modifiers[e]&&window.ROBROY.args.modifiers[e](t)}static propertyExists(e,t){return Object.prototype.hasOwnProperty.call(e,t)}static setMetaTitle(e){const t=document.querySelector("title");t.innerText=e+window.ROBROY.args.metaTitleSeparator+t.innerText}static setPageTitle(e){let t=document.getElementById("robroy-folder-title-text");if(!t){const e=document.createElement("h1");e.setAttribute("id","robroy-folder-title"),window.ROBROY.elements.$container.prepend(e),t=document.createElement("span"),t.setAttribute("id","robroy-folder-title-text"),e.appendChild(t),window.ROBROY.elements.$numImages=document.createElement("small"),window.ROBROY.elements.$numImages.setAttribute("id","robroy-folder-num"),e.appendChild(window.ROBROY.elements.$numImages)}t.innerText=e}static setNumImages(){const e=1===window.ROBROY.currentNumImages?window.ROBROY.lang.singularImageText:window.ROBROY.lang.pluralImageText;window.ROBROY.elements.$numImages.innerText=`(${window.ROBROY.currentNumImages.toLocaleString()} ${e})`}static sprintf(e,...t){return t.forEach((t=>{e=e.replace("%s",t)})),e}}class o{static show(e,t={}){t.closeButtonText=t.closeButtonText||window.ROBROY.lang.ok,t.closeButtonClass=t.closeButtonClass||"";const a=`robroy-modal-${(new Date).getTime()}`,n=document.createElement("div");n.setAttribute("id",a),n.setAttribute("class","robroy-modal"),n.setAttribute("role","alert");const i=document.createElement("div");if(i.setAttribute("class","robroy-modal-box"),n.appendChild(i),t.append)i.appendChild(e);else{const t=document.createElement("p");t.setAttribute("class","robroy-modal-text"),t.innerText=e,i.appendChild(t)}let l;if(!t.hideClose||t.showCancel){const e=document.createElement("p");if(e.setAttribute("class","robroy-modal-options"),i.appendChild(e),!t.hideClose){const a=e=>{r.propertyExists(t,"callback")?t.callback(e):o.hide(e)};l=document.createElement("button"),l.setAttribute("id","robroy-modal-close"),l.setAttribute("type","button"),l.setAttribute("class",`robroy-button ${t.closeButtonClass}`.trim()),l.setAttribute("data-robroy-modal-close",""),t.closeButtonAttributes&&Object.keys(t.closeButtonAttributes).forEach((e=>{l.setAttribute(e,t.closeButtonAttributes[e])})),l.innerText=t.closeButtonText,l.addEventListener("click",a),e.appendChild(l),document.addEventListener("keydown",o.keydownListener,!1)}if(t.showCancel){const t=document.createElement("button");t.setAttribute("id","robroy-modal-cancel"),t.setAttribute("type","button"),t.setAttribute("class","robroy-button robroy-button--secondary"),t.innerText=window.ROBROY.lang.cancel,t.addEventListener("click",this.hide),e.appendChild(t)}}return document.body.appendChild(n),window.ROBROY.activeElement=document.activeElement,n.setAttribute("tabindex","-1"),n.focus(),r.modifier("modal",{element:n}),n}static keydownListener(e){"Escape"===e.key&&(o.hide(),document.removeEventListener("keydown",o.keydownListener))}static hide(e){let t;t=e&&e.target?e.target:document.querySelector("[data-robroy-modal-close]"),t.closest(".robroy-modal").remove(),window.ROBROY.activeElement&&(window.ROBROY.activeElement.focus(),window.ROBROY.activeElement=null)}}class a{static show(){let e=document.querySelector(".robroy-spinner");return e||(e=document.createElement("div"),e.setAttribute("class","robroy-spinner"),e.setAttribute("role","alert"),e.innerText=window.ROBROY.lang.loading,document.body.appendChild(e)),e.style.display="",r.modifier("spinner",{element:e}),e}static hide(e){e.style.display="none"}}class n{static request(e){(e=e||{}).method=e.method||"GET";const t=a.show();window.ROBROY.state.numRequestsInProgress+=1;const r=new XMLHttpRequest;r.onreadystatechange=()=>{if(r.readyState!==XMLHttpRequest.DONE)return;window.ROBROY.state.numRequestsInProgress-=1,window.ROBROY.state.numRequestsInProgress<=0&&a.hide(t);let o=r.responseText;if(o||!(r.status<200||r.status>299)){if(o&&!e.noParse)try{o=JSON.parse(o)}catch(t){return void n.error(e,o,r)}r.status<200||r.status>299?n.error(e,o,r):e.callback(o,r.status)}else n.error(e,o,r)},r.open(e.method,e.url,!0),e.json?(r.setRequestHeader("Content-Type","application/json"),r.send(e.json)):r.send(e.formData)}static error(e,t,a){e.errorCallback?e.errorCallback(t,a.status):o.show(r.sprintf(window.ROBROY.lang.error+window.ROBROY.lang.errorStatus,a.status))}}class i{static add(e,t){e.setAttribute("aria-invalid",!0);const r=e.closest(".robroy-field");r.classList.add("robroy-has-error");const o=document.createElement("span");o.setAttribute("class","robroy-error"),o.setAttribute("id",`robroy-error-${e.getAttribute("id")}`),o.innerText=t,r.append(o)}static clear(e){let t=e.querySelectorAll(".robroy-error");t.forEach((e=>{e.remove()})),t=e.querySelectorAll(".robroy-has-error"),t.forEach((e=>{e.classList.remove("robroy-has-error"),e.removeAttribute("aria-invalid")}))}static show(e,t){if(e.errors){const a=[];e.errors.forEach((e=>{if(e.pointer){const t=document.getElementById(`robroy-input-${e.pointer}`);t?i.add(t,window.ROBROY.lang.error+e.title):a.push(e.title)}else a.push(e.title)})),a.length>0&&o.show(r.sprintf(window.ROBROY.lang.error+a.join(" "),t))}else o.show(r.sprintf(window.ROBROY.lang.error+window.ROBROY.lang.errorStatus,t))}}class l{static show(e,t={}){t.class=t.class||"",t.closeButtonClass=t.closeButtonText||"",t.closeButtonText=t.closeButtonText||window.ROBROY.lang.close,t.duration=t.duration||3e3;let o=document.getElementById("robroy-toast-container");o||(o=document.createElement("div"),o.setAttribute("id","robroy-toast-container"),document.body.append(o));const a=`robroy-toast-${(new Date).getTime()}`,n=document.createElement("div");n.setAttribute("class",`robroy-toast ${t.class}`.trim()),n.setAttribute("id",a),n.setAttribute("role","alert"),n.style.animationDuration=`${t.duration}ms`,o.appendChild(n);const i=document.createElement("p");if(i.setAttribute("class","robroy-toast-text"),i.innerText=e,n.appendChild(i),!t.hideClose){const e=e=>{l.hide(e)},r=document.createElement("button");r.setAttribute("class",`robroy-toast-close ${t.closeButtonClass}`.trim()),r.setAttribute("type","button"),t.closeButtonAttributes&&Object.keys(t.closeButtonAttributes).forEach((e=>{r.setAttribute(e,t.closeButtonAttributes[e])})),r.innerText=t.closeButtonText,r.addEventListener("click",e),n.appendChild(r)}return r.modifier("toast",{element:n}),setTimeout((()=>{n.remove()}),t.duration+1e3),n}static hide(e){e.target.closest(".robroy-toast").remove()}}class s{static load(){window.ROBROY.state.isLoadingFolder=!0,n.request({url:window.ROBROY.args.apiFoldersPath,callback:e=>{e?s.loadFolderCallback(e):n.request({url:`${window.ROBROY.args.apiPath}?type=folders`,callback:e=>{s.loadFolderCallback(e)}})},errorCallback:()=>{n.request({url:`${window.ROBROY.args.apiPath}?type=folders`,callback:e=>{s.loadFolderCallback(e)}})}})}static loadFolderCallback(e){const t=new URLSearchParams(window.location.search).get("folder")||"";let a,n;if(window.ROBROY.folders=e.data,a=""===t?{id:"",type:"folders",attributes:{name:""}}:window.ROBROY.folders[t],a){if(window.ROBROY.currentFolder=a,""!==window.ROBROY.currentFolder.id&&s.initBreadcrumb(),a.attributes.name&&r.setMetaTitle(a.attributes.name),r.setPageTitle(a.attributes.name?a.attributes.name:window.ROBROY.lang.home),""===window.ROBROY.currentFolder.id)n=Object.values(window.ROBROY.folders).filter((e=>!e.id.includes("/")));else{const e=window.ROBROY.currentFolder.id.split("/").length+1;n=Object.values(window.ROBROY.folders).filter((t=>!!t.id.startsWith(`${window.ROBROY.currentFolder.id}/`)&&e===t.id.split("/").length))}n.length>0&&s.appendItems(n),window.ROBROY.state.isLoadingFolder=!1,r.callback("afterLoadFolder",{folder:a})}else o.show(window.ROBROY.lang.error+window.ROBROY.lang.errorFolderDoesNotExist)}static url(e){return`?folder=${e.id}`}static element(e){const t=document.createElement(window.ROBROY.args.folderItemElement);t.setAttribute("class","robroy-folder"),t.setAttribute("data-path",e.id);const o=document.createElement("a");return o.setAttribute("class","robroy-folder-link"),o.setAttribute("href",s.url(e)),o.innerText=e.attributes.name,t.appendChild(o),r.modifier("folderItem",{element:t}),t}static showCreateForm(){const e=s.form(window.ROBROY.lang.titleCreateFolder,"post",s.submitCreateFormCallback),t=e.querySelector("#robroy-input-parent");t&&s.addFolderOptions(t,window.ROBROY.currentFolder.id);const a=e.querySelector("#robroy-field-parent");Object.keys(window.ROBROY.folders).length<=0?a.style.display="none":a.style.display="",r.modifier("folderCreateForm",{element:e}),o.show(e,{append:!0,callback:s.submitCreateFormCallback,closeButtonAttributes:{form:"robroy-folder-form",type:"submit"},closeButtonText:window.ROBROY.lang.save,showCancel:!0})}static showEditForm(){const e=s.form(window.ROBROY.lang.titleEditFolder,"put",s.submitEditFormCallback,window.ROBROY.currentFolder.id),t=e.querySelector("#robroy-input-parent");t&&s.addFolderOptions(t,s.getParentId(window.ROBROY.currentFolder.id));const a=e.querySelector("#robroy-field-parent");Object.keys(window.ROBROY.folders).length<=0?a.style.display="none":a.style.display="",Object.keys(window.ROBROY.currentFolder.attributes).forEach((t=>{const r=e.querySelector(`#robroy-input-${t}`);r&&r.setAttribute("value",window.ROBROY.currentFolder.attributes[t])})),r.modifier("folderEditForm",{element:e}),o.show(e,{append:!0,callback:s.submitEditFormCallback,closeButtonAttributes:{form:"robroy-folder-form",type:"submit"},closeButtonText:window.ROBROY.lang.save,showCancel:!0})}static form(e,t,o,a=""){const n=document.createElement("form");let i=`${window.ROBROY.args.apiPath}?type=folders`;a&&(i+=`&id=${a}`),n.setAttribute("action",i),n.setAttribute("id","robroy-folder-form"),n.setAttribute("method",t),n.addEventListener("submit",o);const l=document.createElement("h2");l.setAttribute("class","robroy-heading"),l.innerText=e,n.appendChild(l);const s=document.createElement("div");return s.setAttribute("class","robroy-fields"),n.appendChild(s),r.addField(s,"name",window.ROBROY.lang.fieldFolderName),r.addField(s,"parent",window.ROBROY.lang.fieldFolderParent,"select"),r.modifier("folderForm",{element:n}),n}static delete(){const e=window.ROBROY.currentFolder.id;o.show(r.sprintf(window.ROBROY.lang.confirmDeleteFolder,window.ROBROY.currentFolder.attributes.name),{closeButtonText:window.ROBROY.lang.delete,closeButtonClass:"robroy-button--danger",showCancel:!0,callback:()=>{s.deleteCallback(e),o.hide()}})}static deleteCallback(e){n.request({method:"DELETE",url:`${window.ROBROY.args.apiPath}?type=folders&id=${e}`,callback:()=>{r.callback("afterDeleteFolder",{id:e});const t=s.getParentId(window.ROBROY.currentFolder.id);window.location=window.location.href.replace(s.url(window.ROBROY.currentFolder),t?s.url(window.ROBROY.folders[t]):"")}})}static submitCreateFormCallback(e){e.preventDefault();const t=document.getElementById("robroy-folder-form");i.clear(t);const r=document.getElementById("robroy-input-name");if(!r.value)return void i.add(r,window.ROBROY.lang.validationRequired);const o=new FormData(t);let a={};o.forEach(((e,t)=>{a[t]=e})),a=JSON.stringify(a),n.request({method:t.getAttribute("method"),url:t.getAttribute("action"),json:a,callback:e=>{s.createRequestCallback(e)},errorCallback:(e,t)=>{i.show(e,t)}})}static createRequestCallback(e){l.show(window.ROBROY.lang.createdSuccessfullyFolder,{class:"robroy-toast--success"});const t=s.getParentId(e.data.id);if(t&&t===window.ROBROY.currentFolder.id||!t&&!window.ROBROY.currentFolder.id){s.addToList(e.data);const t=document.getElementById("robroy-delete-folder");t&&(t.style.display="none")}document.getElementById("robroy-input-name").value="",window.ROBROY.folders[e.data.id]=e.data;const o=document.getElementById("robroy-input-parent");s.addFolderOptions(o,o.value),document.getElementById("robroy-field-parent").style.display="",r.callback("afterCreateFolder",{folder:e.data})}static submitEditFormCallback(e){e.preventDefault();const t=document.getElementById("robroy-folder-form");i.clear(t);const r=document.getElementById("robroy-input-name");if(!r.value)return void i.add(r,window.ROBROY.lang.validationRequired);const a=new FormData(t);let d={},c={};if(a.forEach(((e,t)=>{d[t]=e,Object.prototype.hasOwnProperty.call(window.ROBROY.currentFolder.attributes,t)?c[t]=window.ROBROY.currentFolder.attributes[t]:c[t]=""})),d=JSON.stringify(d),c=JSON.stringify(c),d===c)return l.show(window.ROBROY.lang.nothingToSave),void o.hide(e);n.request({method:t.getAttribute("method"),url:t.getAttribute("action"),json:d,callback:e=>{s.editRequestCallback(e)},errorCallback:(e,t)=>{i.show(e,t)}})}static editRequestCallback(e){r.callback("afterEditFolder",{folder:e.data}),window.location=window.location.href.replace(s.url(window.ROBROY.currentFolder),s.url(e.data))}static appendItems(e){e.forEach((e=>{window.ROBROY.elements.$folderList.appendChild(s.element(e))}))}static addToList(e){let t;const r=window.ROBROY.elements.$folderList.children,o=r.length;let a;for(t=0;t<o&&r[t].getAttribute("data-path")<e.id;t+=1)a=r[t];a?a.after(s.element(e)):window.ROBROY.elements.$folderList.prepend(s.element(e))}static getFullName(e){const t=[e.attributes.name];let r=s.getParentId(e.id);for(;r&&window.ROBROY.folders[r];)e=window.ROBROY.folders[r],t.push(e.attributes.name),r=s.getParentId(e.id);return t.reverse().join(window.ROBROY.args.folderSeparator)}static getParentId(e){const t=e.lastIndexOf("/");return-1===t?"":e.substr(0,t)}static getFolders(){return document.querySelectorAll(`#robroy-folders > ${window.ROBROY.args.folderItemElement}`)}static hasFolders(){return s.getFolders().length>0}static addFolderOptions(e,t){e.innerText="";let r,o=document.createElement("option");o.setAttribute("value",""),e.appendChild(o),Object.keys(window.ROBROY.folders).sort().forEach((a=>{r=window.ROBROY.folders[a],o=document.createElement("option"),o.setAttribute("value",r.id),o.innerText=s.getFullName(window.ROBROY.folders[r.id]),r.id===t&&o.setAttribute("selected","selected"),e.appendChild(o)}))}static initBreadcrumb(){const e=document.createElement("ul");e.setAttribute("class","robroy-breadcrumb"),window.ROBROY.elements.$container.prepend(e);let t=window.ROBROY.currentFolder;do{e.prepend(this.breadcrumbItem(t)),t=window.ROBROY.folders[s.getParentId(t.id)]}while(t);e.prepend(this.breadcrumbItem({id:"",attributes:{name:window.ROBROY.lang.home}})),r.modifier("breadcrumbList",{element:e})}static breadcrumbItem(e){const t=document.createElement("li");if(t.setAttribute("class","robroy-breadcrumb-item"),e.id===window.ROBROY.currentFolder.id)t.innerText=e.attributes.name;else{const r=document.createElement("a");r.setAttribute("class","robroy-breadcrumb-link"),r.setAttribute("href",e.id?s.url(e):window.location.pathname),r.innerText=e.attributes.name,t.prepend(r)}return r.modifier("breadcrumbItem",{element:t,folder:e}),t}}class d{static load(){window.ROBROY.state.isLoadingImages=!0,n.request({url:window.ROBROY.args.apiImagesPath,callback:e=>{e?d.getImagesCallback(e):n.request({url:`${window.ROBROY.args.apiPath}?type=images`,callback:e=>{d.getImagesCallback(e)}})},errorCallback:()=>{n.request({url:`${window.ROBROY.args.apiPath}?type=images`,callback:e=>{d.getImagesCallback(e)}})}})}static getImagesCallback(e){const t=new URLSearchParams(window.location.search).get("folder")||"";let o=Object.values(e.data);if(window.ROBROY.args.showAllImages||(o=o.filter((e=>e.attributes.folder===t))),o.forEach((e=>{window.ROBROY.currentImages[e.id]=e})),d.appendItems(o),window.ROBROY.grid&&window.ROBROY.grid.resizeAllItems(),window.ROBROY.state.allPagesLoaded=!0,window.ROBROY.currentNumImages=o.length,o.length<=0){if(!s.hasFolders()){const e=document.getElementById("robroy-delete-folder");e&&(e.style.display="")}}else{const e=document.getElementById("robroy-delete-folder");e&&(e.style.display="none")}window.ROBROY.state.isLoadingImages=!1,d.onScroll(),window.addEventListener("scroll",r.debounce((()=>{d.onScroll()}),100)),r.callback("afterLoadImages",{images:o})}static element(e,t=!1){const o=document.createElement(window.ROBROY.args.imageItemElement);o.setAttribute("class","robroy-figure"),o.setAttribute("data-path",e.id);const a=document.createElement("a");a.setAttribute("class","robroy-link"),a.setAttribute("href",e.meta.url),o.appendChild(a);const n=document.createElement("img");return e.attributes.title&&n.setAttribute("alt",e.attributes.title),n.setAttribute("class","robroy-img"),n.setAttribute("data-src",e.meta.thumbnail),n.setAttribute("height",e.meta.thumbnailHeight),n.setAttribute("width",e.meta.thumbnailWidth),a.appendChild(n),t&&d.setSrc(n),r.isLoggedIn()&&d.addAdminControls(o),r.modifier("imageItem",{element:o}),o}static showCreateForm(){const e=document.createElement("form");e.setAttribute("action",`${window.ROBROY.args.apiPath}?type=images`),e.setAttribute("enctype","multipart/form-data"),e.setAttribute("id","robroy-image-form"),e.setAttribute("method","post"),e.addEventListener("submit",d.submitCreateFormCallback);const t=document.createElement("h2");t.setAttribute("class","robroy-heading"),t.innerText=window.ROBROY.lang.uploadImage,e.appendChild(t);const a=document.createElement("div");a.setAttribute("class","robroy-field"),a.setAttribute("id","robroy-field-upload"),e.appendChild(a);const n=document.createElement("label");n.setAttribute("class","robroy-label"),n.setAttribute("for","robroy-input-upload"),n.innerText=window.ROBROY.lang.fieldImageImages,a.appendChild(n);const i=document.createElement("div");i.setAttribute("class","robroy-file-container"),a.appendChild(i);const l=document.createElement("input");l.setAttribute("accept","image/*"),l.setAttribute("class","robroy-file-input"),l.setAttribute("id","robroy-input-upload"),l.setAttribute("name","upload[]"),l.setAttribute("multiple","multiple"),l.setAttribute("type","file"),l.addEventListener("change",d.onChange),i.appendChild(l);const s=document.createElement("div");s.setAttribute("class","robroy-file-text"),s.setAttribute("id","robroy-create-image-text"),s.innerText=window.ROBROY.lang.dragImagesOrClickHereToUpload,i.appendChild(s);const c=document.createElement("input");c.setAttribute("name","folder"),c.setAttribute("value",window.ROBROY.currentFolder.id),c.setAttribute("type","hidden"),e.appendChild(c),r.modifier("imageCreateForm",{element:e}),o.show(e,{append:!0,callback:d.submitCreateFormCallback,closeButtonAttributes:{form:"robroy-image-form",type:"submit"},closeButtonText:window.ROBROY.lang.upload,showCancel:!0})}static showEditForm(e){const t=e.target.closest("[data-path]").getAttribute("data-path");window.ROBROY.currentImage=window.ROBROY.currentImages[t];const a=document.createElement("form");a.setAttribute("action",`${window.ROBROY.args.apiPath}?type=images&id=${window.ROBROY.currentImage.id}`),a.setAttribute("id","robroy-image-form"),a.setAttribute("method","PUT"),a.addEventListener("submit",d.submitEditFormCallback);const n=document.createElement("h2");n.setAttribute("class","robroy-heading"),n.innerText=window.ROBROY.lang.titleEditImage,a.appendChild(n);const i=document.createElement("div");i.setAttribute("class","robroy-fields"),a.appendChild(i),r.addField(i,"filename",window.ROBROY.lang.fieldImageFilename);const l=r.addField(i,"folder",window.ROBROY.lang.fieldImageFolder,"select");s.addFolderOptions(l,window.ROBROY.currentImage.attributes.folder),r.addField(i,"title",window.ROBROY.lang.fieldImageTitle),Object.keys(window.ROBROY.currentImage.attributes).forEach((e=>{const t=a.querySelector(`#robroy-input-${e}`);t&&Object.prototype.hasOwnProperty.call(window.ROBROY.currentImage.attributes,e)&&t.setAttribute("value",window.ROBROY.currentImage.attributes[e])})),r.modifier("imageEditForm",{element:a}),o.show(a,{append:!0,callback:d.submitEditFormCallback,closeButtonAttributes:{form:"robroy-image-form",type:"submit"},closeButtonText:window.ROBROY.lang.save,showCancel:!0})}static delete(e){const t=e.target.closest("[data-path]").getAttribute("data-path");o.show(r.sprintf(window.ROBROY.lang.confirmDeleteImage,t),{closeButtonText:window.ROBROY.lang.delete,closeButtonClass:"robroy-button--danger",showCancel:!0,callback:()=>{d.deleteCallback(t),o.hide()}})}static deleteCallback(e){n.request({method:"DELETE",url:`${window.ROBROY.args.apiPath}?type=images&id=${e}`,callback:()=>{l.show(window.ROBROY.lang.deletedSuccessfullyImage,{class:"robroy-toast--success"}),d.removeImageFromList(e),r.callback("afterDeleteImage",{id:e})}})}static submitCreateFormCallback(e){e.preventDefault();const t=document.getElementById("robroy-image-form");i.clear(t);const r=document.getElementById("robroy-input-upload");if(r.files.length<=0)return void i.add(r,window.ROBROY.lang.validationRequired);const o=new FormData(t);n.request({method:t.getAttribute("method"),url:t.getAttribute("action"),formData:o,callback:e=>{d.createRequestCallback(e)},errorCallback:(e,t)=>{i.show(e,t)}})}static createRequestCallback(e){l.show(window.ROBROY.lang.createdSuccessfullyImage,{class:"robroy-toast--success"}),d.prependItems(e.data),window.ROBROY.grid&&window.ROBROY.grid.resizeAllItems(),e.data.forEach((e=>{window.ROBROY.currentImages[e.id]=e})),window.ROBROY.currentNumImages+=e.data.length,r.setNumImages(),document.getElementById("robroy-input-upload").value="",document.getElementById("robroy-create-image-text").innerText=window.ROBROY.lang.dragImagesOrClickHereToUpload;const t=document.getElementById("robroy-delete-folder");t&&(t.style.display="none"),r.callback("afterCreateImage",{image:e.data})}static submitEditFormCallback(e){e.preventDefault();const t=document.getElementById("robroy-image-form");i.clear(t);const r=document.getElementById("robroy-input-filename");if(!r.value)return void i.add(r,window.ROBROY.lang.validationRequired);const a=new FormData(t);let s={},c={};if(a.forEach(((e,t)=>{s[t]=e,Object.prototype.hasOwnProperty.call(window.ROBROY.currentImage.attributes,t)?c[t]=window.ROBROY.currentImage.attributes[t]:c[t]=""})),s=JSON.stringify(s),c=JSON.stringify(c),s===c)return l.show(window.ROBROY.lang.nothingToSave),void o.hide(e);n.request({method:t.getAttribute("method"),url:t.getAttribute("action"),json:s,callback:t=>{d.editRequestCallback(e,t)},errorCallback:(e,t)=>{i.show(e,t)}})}static editRequestCallback(e,t){l.show(window.ROBROY.lang.updatedSuccessfullyImage,{class:"robroy-toast--success"}),document.getElementById("robroy-input-folder").value!==window.ROBROY.currentImage.attributes.folder?d.removeImageFromList(window.ROBROY.currentImage.id):d.updateImage(window.ROBROY.currentImage.id,t.data),delete window.ROBROY.currentImages[window.ROBROY.currentImage.id],window.ROBROY.currentImages[t.data.id]=t.data,window.ROBROY.currentImage=null,o.hide(e),r.callback("afterEditImage",{image:t.data})}static appendItems(e){const t=e.map((e=>d.element(e)));window.ROBROY.elements.$imageList.append(...t)}static prependItems(e){e.forEach((e=>{window.ROBROY.elements.$imageList.prepend(d.element(e,!0))}))}static removeImageFromList(e){const t=document.querySelector(`[data-path="${e}"]`);let o;if(t.nextSibling&&(o=t.nextSibling.querySelector("button")),!o&&t.previousSibling&&(o=t.previousSibling.querySelector("button")),t.remove(),window.ROBROY.currentNumImages-=1,r.setNumImages(),d.hasImages())window.ROBROY.grid&&window.ROBROY.grid.resizeAllItems(),o&&o.focus();else if(!s.hasFolders()){const e=document.getElementById("robroy-delete-folder");e&&(e.style.display="")}}static onChange(e){const t=[...e.target.files].map((e=>e.name));document.getElementById("robroy-create-image-text").innerText=t.join(", ")}static updateImage(e,t){const o=document.querySelector(`[data-path="${e}"]`);o.setAttribute("data-path",t.id),o.querySelector(".robroy-link").setAttribute("href",t.meta.url);const a=o.querySelector(".robroy-img");t.attributes.title?a.setAttribute("alt",t.attributes.title):a.removeAttribute("alt"),r.callback("afterUpdateImage",{image:t,element:o})}static view(e){e.target.closest("[data-path]").querySelector(".robroy-link").click()}static getImages(){return document.querySelectorAll(`#robroy-images > ${window.ROBROY.args.imageItemElement}`)}static hasImages(){return d.getImages().length>0}static addAdminControls(e){if(e.querySelector(".robroy-admin"))return;const t=document.createElement("div");t.setAttribute("class","robroy-admin robroy-button-container"),e.appendChild(t);const r=document.createElement("button");r.setAttribute("class","robroy-button"),r.setAttribute("href","button"),r.innerText=window.ROBROY.lang.view,r.addEventListener("click",d.view),t.appendChild(r);const o=document.createElement("button");o.setAttribute("class","robroy-button robroy-button--secondary"),o.setAttribute("type","button"),o.innerText=window.ROBROY.lang.edit,o.addEventListener("click",d.showEditForm),t.appendChild(o);const a=document.createElement("button");if(a.setAttribute("class","robroy-button robroy-button--danger"),a.setAttribute("type","button"),a.innerText=window.ROBROY.lang.delete,a.addEventListener("click",d.delete),t.appendChild(a),window.ROBROY.args.removePointerEventsOnLogin){const t=e.querySelector(".robroy-link");t.style.pointerEvents="none",t.setAttribute("tabindex",-1)}}static onScroll(){const e=document.querySelectorAll("[data-src]"),t=window.innerHeight,r=window.pageYOffset+t+t;e.forEach((e=>{e.getBoundingClientRect().top<=r&&d.setSrc(e)}))}static setSrc(e){const t=e.getAttribute("data-src");e.setAttribute("src",t),e.removeAttribute("data-src"),e.closest(".robroy-link").style.backgroundImage=`url("${t}")`,r.callback("afterLoadImage",{element:e})}}class c{static init(){window.ROBROY.elements.$authenticateButton&&(window.ROBROY.elements.$authenticateButton.addEventListener("click",(()=>{c.authenticate()})),c.handleAuthentication())}static authenticate(){r.isLoggedIn()?c.logout():c.login()}static logout(){if(window.navigator.userAgent.indexOf("Safari")>-1)return void c.logoutCallback();const e=[window.location.protocol,"//log:out@",window.location.host,`${window.ROBROY.args.apiPath}?type=sessions`].join("");n.request({method:"DELETE",url:e,noParse:!0,callback:()=>{c.logoutCallback()},errorCallback:()=>{c.logoutCallback()}})}static logoutCallback(){window.localStorage.clear(),c.handleLogout()}static login(){n.request({method:"POST",url:`${window.ROBROY.args.apiPath}?type=sessions`,noParse:!0,callback:(e,t)=>{204===t?(window.localStorage.setItem(window.ROBROY.args.localStorageKey,!0),this.handleLogin()):o.show(window.ROBROY.lang.error+window.ROBROY.lang.errorInvalidUsername)}})}static handleAuthentication(){r.isLoggedIn()?c.handleLogin():c.handleLogout()}static handleLogin(){window.ROBROY.elements.$authenticateButton.innerText=window.ROBROY.lang.logOut,document.body.classList.add("robroy-is-admin"),c.addAdminBar(),d.getImages().forEach((e=>{d.addAdminControls(e)})),r.callback("afterLogin")}static handleLogout(){window.ROBROY.elements.$authenticateButton.innerText=window.ROBROY.lang.logIn,document.body.classList.remove("robroy-is-admin");let e=document.querySelectorAll(".robroy-admin");e.forEach((e=>{e.remove()})),window.ROBROY.args.removePointerEventsOnLogin&&(e=document.querySelectorAll(".robroy-link"),e.forEach((e=>{e.removeAttribute("tabindex"),e.style.pointerEvents=""}))),r.callback("afterLogout")}static addAdminBar(){const e=document.createElement("div");e.setAttribute("class","robroy-admin robroy-button-container"),e.setAttribute("id","robroy-admin"),window.ROBROY.elements.$container.prepend(e);const t=document.createElement("button");t.setAttribute("class","robroy-button"),t.setAttribute("id","robroy-create-image"),t.setAttribute("type","button"),t.innerText=window.ROBROY.lang.uploadImage,t.addEventListener("click",d.showCreateForm),e.append(t);const o=document.createElement("button");if(o.setAttribute("class","robroy-button robroy-button--secondary"),o.setAttribute("id","robroy-create-folder"),o.setAttribute("type","button"),o.innerText=window.ROBROY.lang.createFolder,o.addEventListener("click",s.showCreateForm),e.append(o),window.ROBROY.currentFolder.id){const t=document.createElement("button");t.setAttribute("class","robroy-button robroy-button--secondary"),t.setAttribute("id","robroy-edit-folder"),t.setAttribute("type","button"),t.innerText=window.ROBROY.lang.editFolder,t.addEventListener("click",s.showEditForm),e.append(t);const o=document.createElement("button");o.setAttribute("class","robroy-button robroy-button--danger"),o.setAttribute("id","robroy-delete-folder"),o.setAttribute("type","button"),o.innerText=window.ROBROY.lang.deleteFolder,r.isEmpty()||(o.style.display="none"),o.addEventListener("click",s.delete),e.append(o)}r.modifier("adminBar",{element:e})}}class u{constructor(){window.ROBROY.elements.$imageList.classList.add("robroy-grid"),this.calculate(),window.addEventListener("resize",r.debounce((()=>{this.calculate(),this.resizeAllItems()}),100))}calculate(){const e=window.getComputedStyle(window.ROBROY.elements.$imageList);this.gridRowHeight=parseInt(e.getPropertyValue("grid-auto-rows"),10),this.gridRowGap=parseInt(e.getPropertyValue("grid-row-gap"),10)}checkResizeItem(e){const t=e.querySelector("img");this.resizeItem(e,t),t.onload=()=>{this.resizeItem(e,t),e.querySelector("a").classList.add("robroy-show")}}resizeItem(e,t){const r=t.getBoundingClientRect().height,o=Math.ceil((r+this.gridRowGap)/(this.gridRowHeight+this.gridRowGap));e.style.gridRowEnd=`span ${o}`}resizeAllItems(){[...document.getElementsByClassName("robroy-figure")].forEach((e=>{this.checkResizeItem(e)}))}}class m{constructor(e){(e=e||{}).apiFoldersPath=e.apiFoldersPath||"/json/folders.json",e.apiImagesPath=e.apiImagesPath||"/json/images.json",e.apiPath=e.apiPath||"/api.php",e.callbacks=e.callbacks||{},e.enableGrid=r.propertyExists(e,"enableGrid")&&e.enableGrid,e.folderItemElement=e.folderItemElement||"li",e.folderSeparator=e.folderSeparator||" > ",e.imageItemElement=e.imageItemElement||"figure",e.localStorageKey=e.localStorageKey||"authenticated",e.metaTitleSeparator=e.metaTitleSeparator||" | ",e.modifiers=e.modifiers||{},e.pageSize=e.pageSize||8,e.removePointerEventsOnLogin=!r.propertyExists(e,"removePointerEventsOnLogin")||e.removePointerEventsOnLogin,e.selector=e.selector||"#robroy",e.showAllImages=e.showAllImages||!1,this.args=e;const t=document.querySelector(e.selector);if(!t)return;const o=e.lang||{};o.cancel=o.cancel||"Cancel",o.close=o.close||"Close",o.confirmDeleteFolder=o.confirmDeleteFolder||'Are you sure you want to delete the folder "%s"?',o.confirmDeleteImage=o.confirmDeleteImage||'Are you sure you want to delete the image "%s"?',o.createdSuccessfullyImage=o.createdSuccessfullyImage||"Image uploaded successfully.",o.createdSuccessfullyFolder=o.createdSuccessfullyFolder||"Folder created successfully.",o.createFolder=o.createFolder||"Create Folder",o.delete=o.delete||"Delete",o.deletedSuccessfullyImage=o.deletedSuccessfullyImage||"Image deleted successfully.",o.deletedSuccessfullyFolder=o.deletedSuccessfullyFolder||"Folder deleted successfully.",o.deleteFolder=o.deleteFolder||"Delete Folder",o.dragImagesOrClickHereToUpload=o.dragImagesOrClickHereToUpload||"Drag images or click here to upload.",o.edit=o.edit||"Edit",o.editFolder=o.editFolder||"Edit Folder",o.error=o.error||"Error: ",o.errorFolderDoesNotExist=o.errorFolderDoesNotExist||"This folder does not exist.",o.errorInvalidUsername=o.errorInvalidUsername||"Invalid username or password.",o.errorStatus=o.errorStatus||"The server returned a %s error.",o.fieldFolderName=o.fieldFolderName||"Name",o.fieldFolderParent=o.fieldFolderParent||"Parent",o.fieldImageImages=o.fieldImageImages||"Images",o.fieldImageFilename=o.fieldImageFilename||"Filename",o.fieldImageTitle=o.fieldImageTitle||"Title",o.fieldImageFolder=o.fieldImageFolder||"Folder",o.home=o.home||"Home",o.loading=o.loading||"Loading...",o.logIn=o.logIn||"Log In",o.logOut=o.logOut||"Log Out",o.nothingToSave=o.nothingToSave||"Nothing to save.",o.ok=o.ok||"OK",o.pluralImageText=o.pluralImageText||"images",o.save=o.save||"Save",o.singularImageText=o.singularImageText||"image",o.submitCreateFolder=o.submitCreateFolder||"Create",o.submitEditFolder=o.submitEditFolder||"Save",o.titleCreateFolder=o.titleCreateFolder||"Create Folder",o.titleEditFolder=o.titleEditFolder||"Edit Folder",o.titleEditImage=o.titleEditImage||"Edit Image",o.updatedSuccessfullyImage=o.updatedSuccessfullyImage||"Image updated successfully.",o.updatedSuccessfullyFolder=o.updatedSuccessfullyFolder||"Folder updated successfully.",o.upload=o.upload||"Upload",o.uploadImage=o.uploadImage||"Upload Image",o.validationRequired=o.validationRequired||"Error: This field is required.",o.view=o.view||"View",this.lang=o;const a=document.createElement("ul");a.setAttribute("id","robroy-folders"),t.appendChild(a);const n=document.createElement("div");n.setAttribute("id","robroy-images"),t.appendChild(n),this.elements={$authenticateButton:document.querySelector('[data-action="authenticate"]'),$container:t,$folderList:a,$imageList:n},this.state={isLoadingFolder:!1,isLoadingImages:!1,numRequestsInProgress:0},this.currentFolder=null,this.currentImage=null,this.currentImages={},this.currentNumImages=null,this.folders=[]}static init(e){if(!r.propertyExists(window,"ROBROY")){if(window.ROBROY=new m(e),!window.ROBROY.elements.$imageList)return null;s.load(),d.load(),e.enableGrid&&(window.ROBROY.grid=new u);let t=setInterval((()=>{window.ROBROY.state.isLoadingFolder||window.ROBROY.state.isLoadingImages||(c.init(),r.setNumImages(),clearInterval(t),t=null)}),250)}return window.ROBROY}}})(),Robroy=t})();